services:
  # --------------------------------------------------------------------------
  # EXECUTION CLIENT (GETH)
  # --------------------------------------------------------------------------
  geth:
    image: ethereum/client-go:stable
    restart: unless-stopped
    command:
      - --datadir=/execution
      - --http
      - --http.api=eth,net,engine,admin,web3,debug
      - --http.addr=0.0.0.0
      - --http.vhosts=*
      - --http.corsdomain=*
      - --ws
      - --ws.api=eth,net,engine,admin,web3,debug
      - --ws.addr=0.0.0.0
      - --ws.origins=*
      - --authrpc.addr=0.0.0.0
      - --authrpc.vhosts=*
      - --authrpc.jwtsecret=/config/jwt.hex
      # ARCHIVE NODE CONFIGURATION
      - --gcmode=archive
      - --syncmode=full
      - --txlookuplimit=0
      # Network config
      - --networkid=12345
      - --nodiscover
      - --allow-insecure-unlock
      # Metrics
      - --metrics
      - --metrics.addr=0.0.0.0
    ports:
      - "8545:8545" # HTTP RPC
      - "8546:8546" # WS RPC
      - "8551:8551" # Auth RPC
      - "6060:6060" # Metrics
    volumes:
      - ./data/geth:/execution
      - ./config:/config
    depends_on:
      init-jwt:
        condition: service_completed_successfully

  # --------------------------------------------------------------------------
  # GENERATE JWT (Security Automation)
  # --------------------------------------------------------------------------
  init-jwt:
    image: alpine:latest
    command: >
      /bin/sh -c "if [ ! -f /config/jwt.hex ]; then echo 'Generating JWT...'; apk add --no-cache openssl && openssl rand -hex 32 > /config/jwt.hex; fi"
    volumes:
      - ./config:/config

  # --------------------------------------------------------------------------
  # INITIALIZE GETH (Ephemeral)
  # --------------------------------------------------------------------------
  geth-init:
    image: ethereum/client-go:stable
    command:
      - init
      - --datadir=/execution
      - /config/genesis.json
    volumes:
      - ./data/geth:/execution
      - ./config:/config

  # --------------------------------------------------------------------------
  # CONSENSUS CLIENT (PRYSM)
  # --------------------------------------------------------------------------
  beacon:
    image: gcr.io/prysmaticlabs/prysm/beacon-chain:latest
    restart: unless-stopped
    command:
      - --datadir=/consensus
      - --execution-endpoint=http://geth:8551
      - --jwt-secret=/config/jwt.hex
      - --interop-num-validators=64
      - --min-sync-peers=0
      - --interop-eth1data-votes
      - --bootstrap-node=
      - --accept-terms-of-use
      - --rpc-host=0.0.0.0
      - --grpc-gateway-host=0.0.0.0
      - --force-clear-db # Optional: clears DB on restart for devnet cleanliness
      - --monitoring-host=0.0.0.0
    ports:
      - "4000:4000"
      - "3500:3500"
      - "8080:8080"
    volumes:
      - ./data/prysm:/consensus
      - ./config:/config
    depends_on:
      geth:
        condition: service_started

  # --------------------------------------------------------------------------
  # VALIDATOR (PRYSM)
  # --------------------------------------------------------------------------
  validator:
    image: gcr.io/prysmaticlabs/prysm/validator:latest
    restart: unless-stopped
    command:
      - --datadir=/consensus
      - --beacon-rpc-provider=beacon:4000
      - --accept-terms-of-use
      - --interop-num-validators=64
      - --interop-start-index=0
      - --wallet-dir=/consensus/wallet
      - --wallet-password-file=/config/wallet-password.txt
      - --monitoring-host=0.0.0.0
    ports:
      - "8081:8081"
    volumes:
      - ./data/prysm:/consensus
      - ./config:/config
    depends_on:
      beacon:
        condition: service_started

  # --------------------------------------------------------------------------
  # MONITORING (PROMETHEUS)
  # --------------------------------------------------------------------------
  prometheus:
    image: prom/prometheus:latest
    restart: unless-stopped
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --storage.tsdb.path=/prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml
      - ./data/prometheus:/prometheus
    depends_on:
      geth:
        condition: service_started

  # --------------------------------------------------------------------------
  # DASHBOARD (GRAFANA)
  # --------------------------------------------------------------------------
  grafana:
    image: grafana/grafana:latest
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - ./data/grafana:/var/lib/grafana
      - ./config/grafana/provisioning:/etc/grafana/provisioning
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    depends_on:
      prometheus:
        condition: service_started

networks:
  default:
    driver: bridge
