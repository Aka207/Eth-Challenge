services:
  # --------------------------------------------------------------------------
  # EXECUTION CLIENT (GETH) - Ethereum Mainnet Archive Node
  # --------------------------------------------------------------------------
  geth:
    image: ethereum/client-go:stable
    container_name: ETH-archive
    restart: unless-stopped
    ports:
      - "30303:30303"
      - "30303:30303/udp"
      - "8545:8545"
      - "8546:8546"
      - "8551:8551"
      - "6060:6060"
    volumes:
      - ./data/geth:/root/.ethereum
      - ./config/config.toml:/config.toml
    stop_signal: SIGINT
    stop_grace_period: 1m
    healthcheck:
      test: [ "CMD-SHELL", "geth attach --exec eth.blockNumber" ]
      interval: 10s
      timeout: 5s
      retries: 5
    command:
      - --config=/config.toml
      - --syncmode=full
      - --rpc.allow-unprotected-txs
      - --snapshot=false
      - --gcmode=archive
      - --http
      - --http.api=eth,net,web3,engine,admin
      - --http.addr=0.0.0.0
      - --http.vhosts=*
      - --http.corsdomain=*
      - --ws
      - --ws.origins=*
      - --ws.addr=0.0.0.0
      - --ws.api=eth,net,web3
      - --graphql
      - --graphql.corsdomain=*
      - --graphql.vhosts=*
      - --authrpc.addr=0.0.0.0
      - --authrpc.vhosts=*
      - --authrpc.jwtsecret=/root/.ethereum/jwt.hex
      - --authrpc.port=8551
      - --cache=42738
      - --metrics
      - --metrics.addr=0.0.0.0
      - --metrics.port=6060
    depends_on:
      init-jwt:
        condition: service_completed_successfully

  # --------------------------------------------------------------------------
  # GENERATE JWT (Security Automation)
  # --------------------------------------------------------------------------
  init-jwt:
    image: alpine:latest
    command: >
      /bin/sh -c "apk add --no-cache openssl && mkdir -p /data && if [ -d /data/jwt.hex ]; then echo 'Removing jwt.hex directory...'; rm -rf /data/jwt.hex; fi && if [ ! -f /data/jwt.hex ]; then echo 'Generating JWT...'; openssl rand -hex 32 > /data/jwt.hex; else echo 'JWT file already exists'; fi && echo 'JWT setup complete'"
    volumes:
      - ./data/geth:/data

  # --------------------------------------------------------------------------
  # CONSENSUS CLIENT (PRYSM) - Ethereum Mainnet
  # --------------------------------------------------------------------------
  prysm:
    image: gcr.io/offchainlabs/prysm/beacon-chain:latest
    container_name: prysm-beaconchain
    restart: unless-stopped
    stop_grace_period: 1m
    volumes:
      - ./data/prysm:/data
      - ./data/geth/jwt.hex:/geth/jwt.hex
    depends_on:
      geth:
        condition: service_healthy
    ports:
      - "4000:4000"
      - "3500:3500"
      - "13000:13000"
      - "12000:12000/udp"
    command:
      - --accept-terms-of-use
      - --datadir=/data
      - --disable-monitoring
      - --rpc-host=0.0.0.0
      - --execution-endpoint=http://geth:8551
      - --jwt-secret=/geth/jwt.hex
      - --rpc-host=0.0.0.0
      - --rpc-port=4000
      - --grpc-gateway-corsdomain=*
      - --grpc-gateway-host=0.0.0.0
      - --grpc-gateway-port=3500
      - --min-sync-peers=3
      - --suggested-fee-recipient=0xAba865A6826Ba0F02989Ea825084Aa8A5D71b723
      - --checkpoint-sync-url=https://mainnet.checkpoint.sigp.io
      - --genesis-beacon-api-url=https://mainnet.checkpoint.sigp.io

  # --------------------------------------------------------------------------
  # MONITORING (PROMETHEUS)
  # --------------------------------------------------------------------------
  prometheus:
    image: prom/prometheus:latest
    restart: unless-stopped
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --storage.tsdb.path=/prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml
      - ./data/prometheus:/prometheus
    depends_on:
      geth:
        condition: service_started

  # --------------------------------------------------------------------------
  # DASHBOARD (GRAFANA)
  # --------------------------------------------------------------------------
  grafana:
    image: grafana/grafana:latest
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - ./data/grafana:/var/lib/grafana
      - ./config/grafana/provisioning:/etc/grafana/provisioning
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    depends_on:
      prometheus:
        condition: service_started

networks:
  default:
    ipam:
      driver: default
      config:
        - subnet: 99.97.0.0/16
